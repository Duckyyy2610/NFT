{% extends 'main.html' %}
{% load my_custom_tags %}
<!-- {% load static %} -->
{% block content %}
<div class="container">
    <div class="product-detail-web" data-product-id="{{product.id}}">
        <div class="product-detail__img--wrap">
            <div class="img__info">
                <div class="view-original-media">
                </div>
                <form method="POST" class="like-button-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="like">
                    <button type="submit" class="like-button">
                        {% if request.user in product.favorites.all %}
                        <svg class="product-detail__svg" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512" fill="#ff3040"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>
                        {% else %}
                        <svg class="product-detail__svg" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512" fill="#fff"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>
                        {% endif %}
                    </button>
                </form>
            </div>
            <div class="product-detail__img--wrap-2">
                <img src="{{product.image}}" alt="" class="product-detail__img">
            </div>
        </div>
        <div class="product-detail__info">
            <p class="product-detail__topic">{{product.topic}}</p>
            <h1 class="product-detail__name">{{product.name}}</h1>
            <p class="product-detail__author">
                Owned by
                <a href="{% url 'profile' product.author.id %}">{{product.author.name}}</a>
            </p>
            <p class="product-detail__author" style="margin-top: 5px;">
                Created at {{product.created_at|date:'M d, Y'}}
            </p>
            <div class="product-statistic">
                <div class="product-statistic__list flex_aic_jcc">
                    <!-- <li class="product-statistic__item flex_fdc_aif">
                        <p class="product-statistic__value">{{product.rarity}}</p>
                        <p class="product-statistic__key">Rarity</p>
                    </li> -->
                    <li class="product-statistic__item flex_fdc_aif">
                        <p class="product-statistic__value">#{{rarity_rank}} / #{{product_quantity}}</p>
                        <p class="product-statistic__key">Rarity Rank</p>
                    </li>
                    <li class="product-statistic__item flex_fdc_aif">
                        <p class="product-statistic__value total-items">{{product.quantity}}</p>
                        <p class="product-statistic__key">Total items</p>
                    </li>
                    <li class="product-statistic__item flex_fdc_aif">
                        <button class="product-statistic__value product-owner-number">{{product.owners.all|length}}</button>
                        <button class="product-statistic__key product-owner-button">Owners</button>
                    </li>
                    <li class="product-statistic__item flex_fdc_aif">
                        <button class="product-statistic__value product-favorite-number">{{product_favorite_list|length}}</button>
                        <button class="product-statistic__key product-favorite-button">Favorites</button>
                    </li>
                </div>
            </div>
            <div class="product-detail__offer">
                {% if product.quantity == 0 %}
                <p class="product-detail__announce">Sold out</p>
                {% elif product not in request.user.owners.all %}
                <p class="product-detail__current-price">
                    Current price
                </p>
                <p class="product-detail__price">
                    {{product.price}} ETH <span class="product-detail__price-dollars">${% multiply product.price 1547.74 %}</span class="product-detail__price-dollars">
                </p>
                <form action="{% url 'collection1' product.id %}" data-user="{{request.user}}" data-user-id="{{request.user.id}}" data-user-name="{{request.user.name}}" class="cart-add-feature-form">
                    {% csrf_token %}
                    <button class="buy-button">Buy now</button>
                    <button type="submit" class="cart-add-feature flex_aic_jcc">
                        {% if product in request.user.user_cart.cart_products.all|filter_queryset:"product" or product in users.owners.all %}
                        <svg class="product-detail__svg" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 576 512" style="fill:#ffffff"><path d="M0 24C0 10.7 10.7 0 24 0H69.5c22 0 41.5 12.8 50.6 32h411c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3H170.7l5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5H488c13.3 0 24 10.7 24 24s-10.7 24-24 24H199.7c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5H24C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"/>
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 640 512" fill="#fff"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M5.1 9.2C13.3-1.2 28.4-3.1 38.8 5.1l592 464c10.4 8.2 12.3 23.3 4.1 33.7s-23.3 12.3-33.7 4.1L9.2 42.9C-1.2 34.7-3.1 19.6 5.1 9.2z"/></svg>
                        {% else %} 
                        <svg class="product-detail__svg" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 576 512" style="fill:#ffffff"><path d="M0 24C0 10.7 10.7 0 24 0H69.5c22 0 41.5 12.8 50.6 32h411c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3H170.7l5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5H488c13.3 0 24 10.7 24 24s-10.7 24-24 24H199.7c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5H24C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"/>
                        </svg>
                        {% endif %}
                    </button> 
                </form>
                {% else %}
                <p class="product-detail__announce">You have owned this product</p>
                {% endif %}
            </div>
        </div>
        
    </div>

    <div class="product-detail-mobile">
        <div class="product-detail__info-1">
            <p class="product-detail__topic">{{product.topic}}</p>
            <h1 class="product-detail__name">{{product.name}}</h1>
            <p class="product-detail__author">
                Owned by
                <a href="{% url 'profile' product.author.id %}">{{product.author.name}}</a>
            </p>
            <p class="product-detail__author" style="margin-top: 5px;">
                Created at {{product.created_at|date:'M d, Y'}}
            </p>
        </div>
        <div class="product-detail__img--wrap">
            <div class="img__info">
                <div class="view-original-media">
                </div>
                <form method="POST" class="like-button-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="like">
                    <button type="submit" class="like-button">
                        {% if request.user in product.favorites.all %}
                        <svg class="product-detail__svg" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512" fill="#ff3040"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>
                        {% else %}
                        <svg class="product-detail__svg" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512" fill="#fff"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>
                        {% endif %}
                    </button>
                </form>
            </div>
            <div class="product-detail__img--wrap-2">
                <img src="{{product.image}}" alt="" class="product-detail__img">
            </div>
        </div>
        <div class="product-detail__info">
            <div class="product-statistic">
                <div class="product-statistic__list flex_aic_jcc">
                    <!-- <li class="product-statistic__item flex_fdc_aif">
                        <p class="product-statistic__value">{{product.rarity}}</p>
                        <p class="product-statistic__key">Rarity</p>
                    </li> -->
                    <li class="product-statistic__item flex_fdc_aif">
                        <p class="product-statistic__value">#{{rarity_rank}} / #{{product_quantity}}</p>
                        <p class="product-statistic__key">Rarity Rank</p>
                    </li>
                    <li class="product-statistic__item flex_fdc_aif">
                        <p class="product-statistic__value total-items">{{product.quantity}}</p>
                        <p class="product-statistic__key">Total items</p>
                    </li>
                    <li class="product-statistic__item flex_fdc_aif">
                        <button class="product-statistic__value product-owner-number">{{product.owners.all|length}}</button>
                        <button class="product-statistic__key product-owner-button">Owners</button>
                    </li>
                    <li class="product-statistic__item flex_fdc_aif">
                        <button class="product-statistic__value product-favorite-number">{{product_favorite_list|length}}</button>
                        <button class="product-statistic__key product-favorite-button">Favorites</button>
                    </li>
                </div>
            </div>
            <div class="product-detail__offer">
                {% if product.quantity == 0 %}
                <p class="product-detail__announce">Sold out</p>
                {% elif product not in request.user.owners.all %}
                <p class="product-detail__current-price">
                    Current price
                </p>
                <p class="product-detail__price">
                    {{product.price}} ETH <span class="product-detail__price-dollars">${% multiply product.price 1547.74 %}</span class="product-detail__price-dollars">
                </p>
                <form action="{% url 'collection1' product.id %}" data-user="{{request.user}}" data-user-id="{{request.user.id}}" data-user-name="{{request.user.name}}" class="cart-add-feature-form">
                    {% csrf_token %}
                    <button class="buy-button">Buy now</button>
                    <button type="submit" class="cart-add-feature flex_aic_jcc">
                        {% if product in request.user.user_cart.cart_products.all|filter_queryset:"product" or product in users.owners.all %}
                        <svg class="product-detail__svg" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 576 512" style="fill:#ffffff"><path d="M0 24C0 10.7 10.7 0 24 0H69.5c22 0 41.5 12.8 50.6 32h411c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3H170.7l5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5H488c13.3 0 24 10.7 24 24s-10.7 24-24 24H199.7c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5H24C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"/>
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 640 512" fill="#fff"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M5.1 9.2C13.3-1.2 28.4-3.1 38.8 5.1l592 464c10.4 8.2 12.3 23.3 4.1 33.7s-23.3 12.3-33.7 4.1L9.2 42.9C-1.2 34.7-3.1 19.6 5.1 9.2z"/></svg>
                        {% else %} 
                        <svg class="product-detail__svg" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 576 512" style="fill:#ffffff"><path d="M0 24C0 10.7 10.7 0 24 0H69.5c22 0 41.5 12.8 50.6 32h411c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3H170.7l5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5H488c13.3 0 24 10.7 24 24s-10.7 24-24 24H199.7c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5H24C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"/>
                        </svg>
                        {% endif %}
                    </button> 
                </form>
                {% else %}
                <p class="product-detail__announce">You have owned this product</p>
                {% endif %}
            </div>
        </div>
        
    </div>
</div>

<div class="product container-purchase flex_aic_jcc">
    <div class="purchase">
        <div class="purchase__head flex_aic_jcsb">
            <p class="purchase__text purchase__heading">Are you sure to purchase this product ?</p>
            <button class="purchase__close close-button">
                <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M376.6 84.5c11.3-13.6 9.5-33.8-4.1-45.1s-33.8-9.5-45.1 4.1L192 206 56.6 43.5C45.3 29.9 25.1 28.1 11.5 39.4S-3.9 70.9 7.4 84.5L150.3 256 7.4 427.5c-11.3 13.6-9.5 33.8 4.1 45.1s33.8 9.5 45.1-4.1L192 306 327.4 468.5c11.3 13.6 31.5 15.4 45.1 4.1s15.4-31.5 4.1-45.1L233.7 256 376.6 84.5z"/></svg>
            </button>
        </div>
        <div class="purchase__decision">
            <form method="POST" action="" class="product-purchase purchase__decision-form flex_aic_jcsb">
                {% csrf_token %}
                <button type="submit" class="purchase__text purchase__agree">Yes</button>
                <button class="purchase__text purchase__disagree">No</button>
            </form>
        </div>
    </div>
</div>

<div class="product-user-favorite" style="display: none;">
    {% include 'NFTapp/user_behavior.html' with user_behavior_list=product_favorite_list filter="user" behavior_container="container_favorite" behavior_of_user="Favorited by" behavior_of_user_for_ajax="favorite" %}
</div>

<div class="product-user-owned" style="display: none;">
    {% include 'NFTapp/user_behavior.html' with user_behavior_list=product_owner_list filter="user" behavior_container="container_owner" behavior_of_user="Owned by" behavior_of_user_for_ajax="owner" %}
</div>

<div class="gap-between-section"></div>

{% include 'NFTapp/comment.html' with comment_type="product" %}

<div class="gap-between-section"></div>

<div class="container">
    <p class="related-product">Related products</p>
    {% include 'NFTapp/explore/nftproduct/nftproduct2.html' with number_products=6 %}
    <a href="{% url 'collection1' %}" class="view-all-products">View All Products</a>
</div>

{% endblock content %}

{% block scripts %}
<script>
    const productOwnerNumber = document.querySelectorAll(".product-owner-number");
    const productFavoriteNumber = document.querySelectorAll(".product-favorite-number");

    const productOwnerButton = document.querySelectorAll('.product-owner-button');
    const productFavoriteButton = document.querySelectorAll('.product-favorite-button');
    
    const productUserOwned = document.querySelector('.product-user-owned');
    productOwnerNumber.forEach(element => {
        element.onclick = (e) => {
            productUserOwned.style.display = 'block';
        }
    });

    productOwnerButton.forEach(button => {
        button.onclick = (e) => {
            productUserOwned.style.display = 'block';
        }
    });

    const productUserFavorite = document.querySelector('.product-user-favorite');
    productFavoriteNumber.forEach(element => {
        element.onclick = (e) => {
            productUserFavorite.style.display = 'block';
        }
    });

    productFavoriteButton.forEach(button => {
        button.onclick = (e) => {
            productUserFavorite.style.display = 'block';
        }
    });
    
    const commentUpvoteNumber = document.querySelectorAll('.comment__upvote-number');
    commentUpvoteNumber.forEach(element => {
        element.onclick = (e) => {
            element.nextElementSibling.style.display = 'block';
        }
        }
    );

    const commentDisvoteNumber = document.querySelectorAll('.comment__downvote-number');
    commentDisvoteNumber.forEach(element => {
        element.onclick = (e) => {
            element.nextElementSibling.style.display = 'block';
        }
    });

    
    const purchase = document.querySelector('.purchase');
    const containerPurchase = document.querySelector('.product.container-purchase');
    const purchaseClose = document.querySelector('.purchase__close');
    
    if(containerPurchase) {
        purchaseClose.onclick = (e) => {
            containerPurchase.style.display = 'none'
        }
    
        containerPurchase.onclick = (e) => {
            if(e.target !== purchase) {
                containerPurchase.style.display = 'none'
            }
        }
    
        purchase.onclick = (e) => {
            e.stopPropagation();
        }
    
        const purchaseDisagree = document.querySelector('.purchase__disagree');
        purchaseDisagree.onclick = (e) => {
            e.preventDefault();
            containerPurchase.style.display = 'none';
        }
    }

    const buyButton = document.querySelectorAll('.buy-button');
    buyButton.forEach(element => {
        element.onclick = (e) => {
            e.preventDefault();
            containerPurchase.style.display = 'flex';
        }
    })
    
    const productUserBehavior = document.querySelectorAll('.container-user-behavior');
    productUserBehavior.forEach(element => {
        const userBehaviorBlock = element.querySelector(".user-behavior");
        const userBehaviorCloseButton = element.querySelector(".user-behavior__close");
        userBehaviorCloseButton.onclick = (e) => {
            element.parentNode.style.display = "none";
        }
        
        element.onclick =  (e) => {
            if (e.target !== userBehaviorBlock) {
                element.parentNode.style.display = "none";
            }
        };
    
        userBehaviorBlock.onclick = (e) => {
            e.stopPropagation();
        }
        
    })

    function convertDateTimeString(inputDateString) {
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

        const date = new Date(inputDateString);
        const month = months[date.getMonth()];
        const day = date.getDate();
        const year = date.getFullYear();

        return `${month} ${day.toString().padStart(2, '0')}, ${year}`;
    }
    
    function convertDateString(inputDate) {
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        const date = new Date(inputDate);
        const month = months[date.getMonth()];
        const day = date.getDate();
        const year = date.getFullYear();

        const formattedDate = `${month} ${day.toString().padStart(2, '0')}, ${year}`;
        
        return formattedDate;
    }

    function purchaseCartProduct() {
        $('.cart-purchase.purchase__decision-form').on('submit', function(e) {
            console.log($('.container-cart'));
            e.preventDefault();
            $.ajax({
                type: 'POST',
                url: window.location.href,
                data: {
                    'action': 'purchase_cart_product',
                    'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                },
                success: function(response) {
                    let numberProducts = $('.cart-add__number-pro').attr('data-number-products');
                    $('.cart-purchase.container-purchase').css('display', 'none');
                    $('.container-cart').css('display', 'none');
                    $('.cart-add-block .cart-add__number-pro').remove();
                    if(response.state == 'can_buy') {
                        let cartProductsBuyed = JSON.parse(response.cart_products_buyed);
                        let thisProductId = $('product-detail-web').attr('data-product-id');
                        let check = false;
                        for(let product of cartProductsBuyed) {
                            console.log(product);
                            if(thisProductId == product.pk) {
                                check = true;
                            }
                        }

                        $('.cart-product__list').html(`
                            <div class="cart__hint flex_aic_jcc">
                                <div class="cart-hint__inner flex_fdc_aic">
                                    <p class="cart-hint__announce">Add items to get started</p>
                                    <a href="{% url 'artworks1' %}" class="button cart-hint__redirect">Explore now</a>
                                </div>
                            </div>
                        `)
                        $('.cart__amount').html('');
                        $('.cart__footer').html('');
                        $('.profile-product__item').each((index, element) => {
                            if(element.querySelector('.cart-add-feature')) {
                                element.querySelector('.cart-add-feature').innerHTML = `
                                    <svg class="product-detail__svg" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 576 512" style="fill:#ffffff"><path d="M0 24C0 10.7 10.7 0 24 0H69.5c22 0 41.5 12.8 50.6 32h411c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3H170.7l5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5H488c13.3 0 24 10.7 24 24s-10.7 24-24 24H199.7c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5H24C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"/>
                                    </svg>
                                `
                            }
                        })
                        if($(`.owner.container-user-behavior .user-behavior__list`)) {
                            const user = JSON.parse(response.user)[0];
                            const userId = user.pk;
                            const userField = user.fields;
                            $(`.owner.container-user-behavior .user-behavior__list`).append(`
                                <li class="user-behavior__item ${userName} flex_aic_jcc">
                                    <div class="user-behavior__info">
                                        <a href="//${window.location.hostname + (window.location.port ? ":" : "") + window.location.port + "/profile/" + userFavoriteId}/" class="avatar-wrap user-behavior-person__avt-link">
                                            <img src="${userFavoriteField.avatar}" alt="" class="user-behavior-person__avt avatar">
                                        </a>
                                        <div class="user-behavior-person flex_aic_jcc">
                                            <div class="user-behavior-person__text-block flex_fdc_aif">
                                                <a href="//${window.location.hostname + (window.location.port ? ":" : "") + window.location.port + "/profile/" + userFavoriteId}/" class="user-behavior-person__name">${userFavoriteField.name}</a>
                                                <a href="//${window.location.hostname + (window.location.port ? ":" : "") + window.location.port + "/profile/" + userFavoriteId}/" class="user-behavior-person__id">${userFavoriteId.slice(0,6) + '...' +userFavoriteId.slice(-4)}</a>
                                            </div>
                                        </div>     
                                    </div>
                                </li>  
                            `)
                        }

                        $('.flash-message-wrap').prepend(`
                            <div class="flash-message flash-message-add flex_aic_jcc">
                                <div class="flash-message__icon flex_aic_jcc">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512" fill="#fff"><path d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/></svg>
                                </div>
                                <p class="flash-message__text">Buy successfully</p>
                            </div>
                        `);     
                        $('.flash-message-add:first-child').delay(2000).slideUp(300);
                        if($('.product-detail__offer') && check) {
                            $('.product-detail__offer').each((index, element) => {
                                $(element).html(`
                                    <p class="product-detail__announce">You have owned this product</p>
                                `);
                            });
                        }

                    }
                    else {
                        $('.flash-message-wrap').prepend(`
                            <div class="flash-message flash-message-add flash-message-comment flex_aic_jcc">
                                <div class="flash-message__icon flex_aic_jcc">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" fill="#fff"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M376.6 84.5c11.3-13.6 9.5-33.8-4.1-45.1s-33.8-9.5-45.1 4.1L192 206 56.6 43.5C45.3 29.9 25.1 28.1 11.5 39.4S-3.9 70.9 7.4 84.5L150.3 256 7.4 427.5c-11.3 13.6-9.5 33.8 4.1 45.1s33.8 9.5 45.1-4.1L192 306 327.4 468.5c11.3 13.6 31.5 15.4 45.1 4.1s15.4-31.5 4.1-45.1L233.7 256 376.6 84.5z"/></svg>                                    </div>
                                <p class="flash-message__text">You don't have enough money for this</p>
                            </div>
                        `);                                 
                        $('.flash-message-comment').delay(2000).slideUp(300);
                        $('.cart-add').append(`
                            <span class="cart-add__number-pro flex_aic_jcc" data-number-products="${numberProducts}">${numberProducts}</span>
                        `)
                    }
                }, 
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log(errorThrown);
                }
            })
        })
    }

    $(document).ready(function() {
        const likeButtonForm = document.querySelectorAll('.like-button-form');
        const userFavoriteId = '{{request.user.id|escapejs}}';
        const userName = '{{request.user.name|escapejs}}';
        const favoriteList = document.querySelector('.favorite.user-behavior__list');
        const productFavoriteNumber = document.querySelectorAll('.product-favorite-number');

        likeButtonForm.forEach((element, index) => {
            element.onsubmit = (e) => {
                const likeButton = element.children[2];
                e.preventDefault();
                $.ajax({
                    type: "POST",
                    // url: ,
                    data: {
                        'action': 'like',
                        'csrfmiddlewaretoken': element.children[0].value, 
                    },
                    success: function(response) {
                        const userFavorite = JSON.parse(response['user_favorites'])[0];
                        const userFavoriteField = userFavorite.fields;
                        productFavoriteNumber[index].textContent = `${response['number_favorites']}`;
                        if(response['state'] == 'like') {
                            likeButton.innerHTML = `
                                <svg class="product-detail__svg" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512" fill="#ff3040"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>
                            `;
                            let new_user_favorite = `
                            <li class="user-behavior__item ${userName} flex_aic_jcc">
                                <div class="user-behavior__info">
                                    <a href="//${window.location.hostname + (window.location.port ? ":" : "") + window.location.port + "/profile/" + userFavoriteId}/" class="avatar-wrap user-behavior-person__avt-link">
                                        <img src="${userFavoriteField.avatar}" alt="" class="user-behavior-person__avt avatar">
                                    </a>
                                    <div class="user-behavior-person flex_aic_jcc">
                                        <div class="user-behavior-person__text-block flex_fdc_aif">
                                            <a href="//${window.location.hostname + (window.location.port ? ":" : "") + window.location.port + "/profile/" + userFavoriteId}/" class="user-behavior-person__name">${userFavoriteField.name}</a>
                                            <a href="//${window.location.hostname + (window.location.port ? ":" : "") + window.location.port + "/profile/" + userFavoriteId}/" class="user-behavior-person__id">${userFavoriteId.slice(0,6) + '...' +userFavoriteId.slice(-4)}</a>
                                        </div>
                                    </div>     
                                </div>
                            </li>
                            `;
                            $('.favorite.user-behavior__list').append(new_user_favorite);
                            // favoriteList.insertAdjacentElement('beforeend', new_user_favorite);
                        } else {
                            likeButton.innerHTML = `
                                <svg class="product-detail__svg" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512" fill="#fff"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>
                            `;
                            if(favoriteList.querySelector(`.user-behavior__item.${userName}`)) {
                                favoriteList.removeChild(favoriteList.querySelector(`.user-behavior__item.${userName}`));
                            }
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                      console.log(jqXHR, textStatus, errorThrown);  
                    }
                })
                
            }
        })

        const profileProductList = $('.cart-add-feature-form');
        const requestUserData = profileProductList.eq(0).attr('data-user');
        const requestUserDataId = profileProductList.eq(0).attr('data-user-id');
        const requestUserDataName = profileProductList.eq(0).attr('data-user-name');
        
        $('.cart-add-feature-form').each((index, element) => {
            $(element).on("submit", function(e) {
                e.preventDefault();
                $.ajax({
                    type: "POST",
                    // url: ,
                    data: {
                        'action': 'cart_add',
                        'csrfmiddlewaretoken': $(element).find('input[name=csrfmiddlewaretoken]').val(),
                    },
                    success: function(response) {
                        var product = JSON.parse(response.product);
                        
                        var productData = product[0];
                        var productAuthorData = product[1];
                        var productTopicData = product[2];
    
                        var productDataId = productData.pk;
                        var productDataField = productData.fields;
    
                        var productAuthorDataId = productAuthorData.pk;
                        var productAuthorDataField = productAuthorData.fields;
    
                        var productTopicDataField = productTopicData.fields;
                        
                        var itemAmount = `${response.number_cart_products} ${response.number_cart_products == 1 ? 'item' : 'items'}`;
                        var totalPrice = response.total_price;
                        var totalPriceETH = `${parseFloat(response.total_price).toFixed(3)} ETH`;
                        var totalPriceDollar = `$${parseFloat(response.total_price * 1789).toFixed(2)}`;
                        var newCartProductList = [];
                        if (response.state == 'cart_add') {
                            let newCartProduct =  `
                                <li data-product-id="${productDataId}" class="${productDataField.name} cart-product__item flex_aic_jcsb">
                                    <div class="cart__product--wrap flex_aic_jcsb">
                                        <a href="//${window.location.hostname + (window.location.port ? ":" : "") + window.location.port + "/collection1/" +productDataId}" class="cart-product__img--wrap">
                                            <img src="${productDataField.image}" alt="" class="cart-product__img">
                                        </a>
                                        <div class="cart-product__info">
                                            <p class=" cart-product__name"><a href="//${window.location.hostname + (window.location.port ? ":" : "") + window.location.port + "/collection1/" +productDataId}" class="cart-text">${productDataField.name}</a></p>
                                            <p class="cart-text-2 cart-product__topic">${productTopicDataField.name}</p>
                                            <p class="cart-text-2 cart-product__price">${parseFloat(productDataField.price).toFixed(3)} ETH</p>
                                            <button class="cart-product__detail">Show Details</button>
                                            <div class="container-cart-detail">
                                                <div class="cart-detail">
                                                    <div class="cart-detail__head flex_aic_jcsb">
                                                        <p class="cart-text cart-detail__heading">This is an unreviewed collection</p>
                                                        <button class="cart-detail__close close-button">
                                                            <svg xmlns="http:www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https:fontawesome.com License - https:fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M376.6 84.5c11.3-13.6 9.5-33.8-4.1-45.1s-33.8-9.5-45.1 4.1L192 206 56.6 43.5C45.3 29.9 25.1 28.1 11.5 39.4S-3.9 70.9 7.4 84.5L150.3 256 7.4 427.5c-11.3 13.6-9.5 33.8 4.1 45.1s33.8 9.5 45.1-4.1L192 306 327.4 468.5c11.3 13.6 31.5 15.4 45.1 4.1s15.4-31.5 4.1-45.1L233.7 256 376.6 84.5z"/></svg>
                                                        </button>
                                                    </div>
                                                    <div class="cart-detail__info">
                                                        <div class="cart-detail__table--wrap">
                                                            <table class="cart-detail__table">
                                                                <tr>
                                                                    <td class="cart-text-2">Collection name</td>
                                                                    <td class=""><a href="//${window.location.hostname + (window.location.port ? ":" : "") + window.location.port + "/collection1/" + productDataId}" class="cart-text-2">${productDataField.name}</a></td>
                                                                </tr>
                                                                <tr>
                                                                    <td class="cart-text-2">Creator</td>
                                                                    <td class="cart-text-2">
                                                                        <a href="//${window.location.hostname + (window.location.port ? ":" : "") + window.location.port + "/profile/" + requestUserDataId}" class="cart-detail__author">${productAuthorDataField.name}</a>
                                                                        <p class="">Joined in ${convertDateTimeString(productAuthorDataField.date_joined)}</p>
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td class="cart-text-2">Total sales</td>
                                                                    <td class="cart-text-2">0 ETH</td>
                                                                </tr>
                                                                <tr>
                                                                    <td class="cart-text-2">Total volume</td>
                                                                    <td class="cart-text-2">
                                                                        <p class="">0 ETH</p>
                                                                        <p class="">$0</p>
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td class="cart-text-2">Total items</td>
                                                                    <td class="cart-text-2">${productDataField.quantity}</td>
                                                                </tr>
                                                                <tr>
                                                                    <td class="cart-text-2">Created Date</td>
                                                                    <td class="cart-text-2">${convertDateTimeString(productDataField.created_at)}</td>
                                                                </tr>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <form action="" class="{{product.name}} cart-product__delete-form">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="delete_cart_product">
                                        <button class="cart-product__delete">
                                            <svg xmlns="http:www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512" fill="#fff"><!--! Font Awesome Free 6.4.2 by @fontawesome - https:fontawesome.com License - https:fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M164.2 39.5L148.9 64H299.1L283.8 39.5c-2.9-4.7-8.1-7.5-13.6-7.5H177.7c-5.5 0-10.6 2.8-13.6 7.5zM311 22.6L336.9 64H384h32 16c8.8 0 16 7.2 16 16s-7.2 16-16 16H416V432c0 44.2-35.8 80-80 80H112c-44.2 0-80-35.8-80-80V96H16C7.2 96 0 88.8 0 80s7.2-16 16-16H32 64h47.1L137 22.6C145.8 8.5 161.2 0 177.7 0h92.5c16.6 0 31.9 8.5 40.7 22.6zM64 96V432c0 26.5 21.5 48 48 48H336c26.5 0 48-21.5 48-48V96H64zm80 80V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V176c0-8.8 7.2-16 16-16s16 7.2 16 16zm96 0V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V176c0-8.8 7.2-16 16-16s16 7.2 16 16zm96 0V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V176c0-8.8 7.2-16 16-16s16 7.2 16 16z"/></svg>
                                        </button>
                                    </form>
                                </li>
                            `
                            $('.cart-add-block .flash-message-wrap').prepend(`
                                <div class="flash-message flash-message-add flex_aic_jcc">
                                    <div class="flash-message__icon flex_aic_jcc">
                                        <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512" fill="#fff"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/></svg>
                                    </div>
                                    <p class="flash-message__text">Added to cart</p>
                                </div>
                            `);

                            $('.flash-message-add').click(function(e) {
                                $('.container-cart').css('display', 'block');   
                            })
                            
                            $('.flash-message-add:first-child').delay(2000).slideUp(300);

                            $(element).find('.cart-add-feature').html(`
                                <svg class="product-detail__svg" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 576 512" style="fill:#ffffff"><path d="M0 24C0 10.7 10.7 0 24 0H69.5c22 0 41.5 12.8 50.6 32h411c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3H170.7l5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5H488c13.3 0 24 10.7 24 24s-10.7 24-24 24H199.7c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5H24C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"/>
                                </svg>
                                <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 640 512" fill="#fff"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M5.1 9.2C13.3-1.2 28.4-3.1 38.8 5.1l592 464c10.4 8.2 12.3 23.3 4.1 33.7s-23.3 12.3-33.7 4.1L9.2 42.9C-1.2 34.7-3.1 19.6 5.1 9.2z"/></svg>
                            `);
                            if(response.number_cart_products == 1) {
                                $(`.${requestUserDataName}.cart-product__list`).html(newCartProduct);
                                $('.cart__amount').html(`
                                    <p class="cart-text cart__number">${itemAmount}</p>
                                    <form method="POST" action="" class="cart__clear-form">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="clear_cart_product">
                                        <button type="submit" class="cart-text cart__clear">Clear all</button>
                                    </form>
                                `);
    
                                $('.cart__hint').html('');
                                $('.cart__footer').html(`
                                    <div class="cart__price flex_aic_jcsb">
                                        <p class="cart-text cart__price-key">Total price</p>
                                        <div class="cart__price-value">
                                            <p class="cart-text cart__price-value-eth">${totalPriceETH}</p>
                                            <p class="cart-text-2 cart__price-value-dollar">${totalPriceDollar}</p>
                                        </div>
                                    </div>
                                    <button type="submit" class="cart__buy-button">Complete purchase</button>

                                    <div class="cart-purchase container-purchase flex_aic_jcc">
                                        <div class="purchase">
                                            <div class="purchase__head flex_aic_jcsb">
                                                <p class="purchase__text purchase__heading">Are you sure to purchase this product ?</p>
                                                <button class="purchase__close close-button">
                                                    <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M376.6 84.5c11.3-13.6 9.5-33.8-4.1-45.1s-33.8-9.5-45.1 4.1L192 206 56.6 43.5C45.3 29.9 25.1 28.1 11.5 39.4S-3.9 70.9 7.4 84.5L150.3 256 7.4 427.5c-11.3 13.6-9.5 33.8 4.1 45.1s33.8 9.5 45.1-4.1L192 306 327.4 468.5c11.3 13.6 31.5 15.4 45.1 4.1s15.4-31.5 4.1-45.1L233.7 256 376.6 84.5z"/></svg>
                                                </button>
                                            </div>
                                            <div class="purchase__decision">
                                                <form method="POST" action="" class="cart-purchase purchase__decision-form flex_aic_jcsb">
                                                    {% csrf_token %}
                                                    <button type="submit" class="purchase__text purchase__agree">Yes</button>
                                                    <button class="purchase__text purchase__disagree">No</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                `); 

                                const $cartContainerPurchase = $('.cart-purchase.container-purchase');
                                
                                const $cartBuyButton = $('.cart__buy-button');
                                console.log($($cartBuyButton));
                                if($cartBuyButton && $cartContainerPurchase) {
                                    $cartBuyButton.click((e) => {
                                        e.preventDefault();
                                        $cartContainerPurchase.css('display', 'flex');
                                    })
                                }
                                
                                if($cartContainerPurchase) {
                                    $('.purchase__close').click((e) => {
                                        $cartContainerPurchase.css('display', 'none');
                                    });
                            
                                    $cartContainerPurchase.click((e) => {
                                        if(e.target !== $('.cart-purchase .purchase')) {
                                            $cartContainerPurchase.css('display', 'none');
                                        }
                                    });
                                    
                                    $('.cart-purchase .purchase').click((e) => {
                                        e.stopPropagation();
                                    });

                                    $('.purchase__disagree').click((e) => {
                                        e.preventDefault();
                                        $cartContainerPurchase.css('display', 'none');
                                    });
                                }

                                $('.cart-add').append(`
                                    <span class="cart-add__number-pro flex_aic_jcc">${response.number_cart_products}</span>
                                `)
    
                                
                            } else {
                                $(`.${requestUserDataName}.cart-product__list`).append(newCartProduct);
                                $('.cart__number').text(`${itemAmount}`);
                                $('.cart__price-value-eth').text(`${totalPriceETH}`);
                                $('.cart__price-value-dollar').text(`${totalPriceDollar}`);
                                $('.cart-add__number-pro').text(`${response.number_cart_products}`);
                            }
                            newCartProductList.push($(`.${requestUserDataName}.cart-product__list .cart-product__item:last-child`));
                        } else {
                            $('.cart-add-block .flash-message-wrap').prepend(`
                                <div class="flash-message flash-message-remove flex_aic_jcc">
                                    <div class="flash-message__icon flex_aic_jcc">
                                        <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512" fill="#fff"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/></svg>
                                    </div>
                                    <p class="flash-message__text">Removed from cart</p>
                                </div>
                            `);
                            $('.flash-message-remove:first-child').delay(2000).slideUp(300);

                            $(element).find('.cart-add-feature').html(`
                                <svg class="product-detail__svg" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 576 512" style="fill:#ffffff"><path d="M0 24C0 10.7 10.7 0 24 0H69.5c22 0 41.5 12.8 50.6 32h411c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3H170.7l5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5H488c13.3 0 24 10.7 24 24s-10.7 24-24 24H199.7c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5H24C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"/>
                                </svg>
                            `);
                            if(response.number_cart_products == 0) {
                                $(`.${requestUserDataName}.cart-product__list`).html(`
                                    <div class="cart__hint flex_aic_jcc">
                                        <div class="cart-hint__inner flex_fdc_aic">
                                            <p class="cart-hint__announce">Add items to get started</p>
                                            <a href="{% url 'artworks1' %}" class="button cart-hint__redirect">Explore now</a>
                                        </div>
                                    </div>
                                `);
                                $('.cart__amount').html('');
                                $('.cart__footer').html('');
                                $('.cart-add-block .cart-add__number-pro').remove();
                            }
                            else {
                                $('.cart__number').text(`${itemAmount}`);
                                $(`.${requestUserDataName}.cart-product__list`).find(`.${productDataField.name}.cart-product__item`).remove();
                                $('.cart__price-value-eth').text(`${totalPriceETH}`);
                                $('.cart__price-value-dollar').text(`${totalPriceDollar}`);
                                $('.cart-add__number-pro').text(`${response.number_cart_products}`);
                            }
                        }

                        $('.cart__clear-form').on('submit', function(e) {
                            e.preventDefault();
                            $.ajax({
                                type: 'POST',
                                url: window.location.href,
                                data: {
                                    'action': 'clear_cart_product',
                                    'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                                },
                                success: function(response) {
                                    console.log(response['state']);
                                    if(response.state == 'clear_cart_product') {
                                        $('.cart-product__list').html(`
                                            <div class="cart__hint flex_aic_jcc">
                                                <div class="cart-hint__inner flex_fdc_aic">
                                                    <p class="cart-hint__announce">Add items to get started</p>
                                                    <a href="{% url 'artworks1' %}" class="button cart-hint__redirect">Explore now</a>
                                                </div>
                                            </div>
                                        `)
                                        $('.cart__amount').html('');
                                        $('.cart__footer').html('');
                                        $(`.cart-add-feature`).html(`
                                            <svg class="product-detail__svg" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 576 512" style="fill:#ffffff"><path d="M0 24C0 10.7 10.7 0 24 0H69.5c22 0 41.5 12.8 50.6 32h411c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3H170.7l5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5H488c13.3 0 24 10.7 24 24s-10.7 24-24 24H199.7c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5H24C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"/>
                                            </svg>
                                        `);
                                        $('.cart-add-block .cart-add__number-pro').remove();
                                        
                                    }
                                },
                                error: function(jqXHR, textStatus, errorTh) {
                                    console.log(jqXHR, textStatus, errorTh);
                                }
                            })
                        })

                        newCartProductList.forEach(element => {
                            const $cartClose = $(element).find('.cart__close');
                            const $containerCart = $(element).find('.container-cart');
                            const $cart = $(element).find('.cart');
                            $cartClose.click(function(e) {
                                $(element).find('.container-cart').css('display', 'none');
                            })

                            $containerCart.click(function(e) {
                                if(e.target !== $cart) {
                                    $(this).css('display', 'none')
                                }
                            })

                            $cart.click(function(e) {
                                e.stopPropagation();
                            }) 
        
                            const $containerCartDetail = $(element).find('.container-cart-detail');
                            const $cartDetailClose = $containerCartDetail.find('.cart-detail__close');
                            const $cartDetail = $containerCartDetail.find('.cart-detail');
                            
                            if($containerCartDetail) {
                                $cartDetailClose.click(function (e) {
                                    $containerCartDetail.css('display', 'none');
                                });

                                $containerCartDetail.click(function (e) {
                                    if(e.target !== $cartDetail) {
                                        $containerCartDetail.css('display', 'none');
                                    }
                                })

                                $cartDetail.click(function(e) {
                                    e.stopPropagation();
                                })

                                const $cartProductDetail = $(element).find('.cart-product__detail');                            
                                $cartProductDetail.click(function (e) {
                                    $containerCartDetail.css('display', 'block');
                                })
                            }

                            $(element).find('.cart-product__delete-form').on("submit", function(e) {
                                e.preventDefault();
                                $.ajax({
                                    type: 'POST',
                                    // url: ,
                                    data: {
                                        'action': 'delete_cart_product',
                                        'product_id': element.attr('data-product-id'),
                                        'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                                    },
                                    success: function(response) {
                                        const productDelete = JSON.parse(response.product_delete)[0];
                                        const productDeleteDataField = productDelete.fields;
                                        var totalPriceETH = `${parseFloat(response.total_price).toFixed(3)} ETH`;
                                        var totalPriceDollar = `$${parseFloat(response.total_price * 1789).toFixed(2)}`;
                                        var itemAmount = `${response.number_cart_products} ${response.number_cart_products == 1 ? 'item' : 'items'}`;
                                        
                                        $('.cart__price-value-eth').text(`${totalPriceETH}`);
                                        $('.cart__price-value-dollar').text(`${totalPriceDollar}`);
                                        if(response.state == 'delete_cart_product') {
                                            $('.cart__number').text(`${itemAmount}`);
                                            if(response.number_cart_products != 0) {
                                                $(`.${requestUserDataName}.cart-product__list`).find(element).remove();
                                                $('.cart-add__number-pro').text(`${response.number_cart_products}`);
                                            }
                                            else {
                                                $(`.${requestUserDataName}.cart-product__list`).html(`
                                                    <div class="cart__hint flex_aic_jcc">
                                                        <div class="cart-hint__inner flex_fdc_aic">
                                                            <p class="cart-hint__announce">Add items to get started</p>
                                                            <a href="{% url 'artworks1' %}" class="button cart-hint__redirect">Explore now</a>
                                                        </div>
                                                    </div>`);
                                                $('.cart__amount').html('');
                                                $('.cart__footer').html('');
                                                
                                                $('.cart-add-block .cart-add__number-pro').remove();
                                            }
                                        }
                                        $(`.cart-add-feature`).html(`
                                            <svg class="product-detail__svg" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 576 512" style="fill:#ffffff"><path d="M0 24C0 10.7 10.7 0 24 0H69.5c22 0 41.5 12.8 50.6 32h411c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3H170.7l5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5H488c13.3 0 24 10.7 24 24s-10.7 24-24 24H199.7c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5H24C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"/>
                                            </svg>
                                        `);
                                    },
                                    error: function(jqXHR, textStatus, errorTh) {
                                        console.log(jqXHR, textStatus, errorTh);
                                    }
                                })
                            })
                        })
                        purchaseCartProduct();
                    }
                })
            })
        })

        
        $('.product-purchase.purchase__decision-form').on('submit', (e) => {
            e.preventDefault();
            $.ajax({
                type: 'POST',
                // contentType: 'application/json',
                // url: '',
                data: {
                    'action': 'purchase_product',
                    'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                },
                success: function(response) {
                    const product = JSON.parse(response.product)[0];
                    const productField = product.fields;
                    const totalItems = parseInt(`${$('.total-items').first().text()}`) - 1;

                    var totalPriceETH = `${parseFloat(response.total_price).toFixed(3)} ETH`;
                    var totalPriceDollar = `$${parseFloat(response.total_price * 1789).toFixed(2)}`;
                    let itemAmount = `${response.number_cart_products} ${response.number_cart_products == 1 ? 'item' : 'items'}`;
                    console.log(totalPriceETH, totalPriceDollar)
                    $('.product.container-purchase').css('display', 'none');
                    $('.cart__price-value-eth').text(`${totalPriceETH}`);
                    $('.cart__price-value-dollar').text(`${totalPriceDollar}`);
                    if(response.state == 'can_buy') {
                        if(productField.quantity > 0) {
                            $('.total-items').text(`${totalItems}`);
                            if(totalItems == 0) {
                                $('.product-detail__offer').each((index, element) => {
                                    $(element).html(`
                                        <p class="product-detail__announce">Sold out</p>
                                    `);
                                });
                            }
                            if(response.number_cart_products != 0) {
                                $(`.${productField.name}.cart-product__item`).remove();
                                $('.cart-add__number-pro').text(`${response.number_cart_products}`);
                            }
                            else {
                                $(`.cart-product__list`).html(`
                                    <div class="cart__hint flex_aic_jcc">
                                        <div class="cart-hint__inner flex_fdc_aic">
                                            <p class="cart-hint__announce">Add items to get started</p>
                                            <a href="{% url 'artworks1' %}" class="button cart-hint__redirect">Explore now</a>
                                        </div>
                                    </div>`);
                                $('.cart__amount').html('');
                                $('.cart__footer').html('');
                                $('.cart-add-block .cart-add__number-pro').remove();
                            }
    
                            $('.flash-message-wrap').prepend(`
                                <div class="flash-message flash-message-add flex_aic_jcc">
                                    <div class="flash-message__icon flex_aic_jcc">
                                        <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512" fill="#fff"><path d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/></svg>
                                    </div>
                                    <p class="flash-message__text">Buy successfully</p>
                                </div>
                            `);     
    
                            $('.flash-message-add:first-child').delay(2000).slideUp(300);
                            
                            $('.product-detail__offer').each((index, element) => {
                                $(element).html(`
                                    <p class="product-detail__announce">You have owned this product</p>
                                `);
                            });
                            
                            $('.cart__number').text(`${itemAmount}`);
                            
                            if('.owner.container-user-behavior .user-behavior__list') {
                                const user = JSON.parse(response.user)[0];
                                const userId = user.pk;
                                const userField = user.fields;
                                
                                const numberOwners = parseInt($(`.product-owner-number`).eq(0).text()) + 1;

                                $(`.product-owner-number`).each((index, element) => {
                                    $(element).text(``);
                                    $(element).text(`${numberOwners}`);
                                });
                                
                                $(`.owner.container-user-behavior .user-behavior__list`).append(`
                                    <li class="user-behavior__item ${userField.name} flex_aic_jcc">
                                        <div class="user-behavior__info">
                                            <a href="//${window.location.hostname + (window.location.port ? ":" : "") + window.location.port + "/profile/" + userId}/" class="avatar-wrap user-behavior-person__avt-link">
                                                <img src="${userField.avatar}" alt="" class="user-behavior-person__avt avatar">
                                            </a>
                                            <div class="user-behavior-person flex_aic_jcc">
                                                <div class="user-behavior-person__text-block flex_fdc_aif">
                                                    <a href="//${window.location.hostname + (window.location.port ? ":" : "") + window.location.port + "/profile/" + userId}/" class="user-behavior-person__name">${userField.name}</a>
                                                    <a href="//${window.location.hostname + (window.location.port ? ":" : "") + window.location.port + "/profile/" + userId}/" class="user-behavior-person__id">${userId.slice(0,6) + '...' +userId.slice(-4)}</a>
                                                </div>
                                            </div>     
                                        </div>
                                    </li>  
                                `);
                            }
                            
                        }
                        else {
                            $('.flash-message-wrap').prepend(`
                                <div class="flash-message flash-message-add flash-message-comment flex_aic_jcc">
                                    <div class="flash-message__icon flex_aic_jcc">
                                        <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" fill="#fff"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M376.6 84.5c11.3-13.6 9.5-33.8-4.1-45.1s-33.8-9.5-45.1 4.1L192 206 56.6 43.5C45.3 29.9 25.1 28.1 11.5 39.4S-3.9 70.9 7.4 84.5L150.3 256 7.4 427.5c-11.3 13.6-9.5 33.8 4.1 45.1s33.8 9.5 45.1-4.1L192 306 327.4 468.5c11.3 13.6 31.5 15.4 45.1 4.1s15.4-31.5 4.1-45.1L233.7 256 376.6 84.5z"/></svg>                                    </div>
                                    <p class="flash-message__text">Out of stock</p>
                                </div>
                            `);   
                        }
                    }
                    else {
                        $('.flash-message-wrap').prepend(`
                            <div class="flash-message flash-message-add flash-message-comment flex_aic_jcc">
                                <div class="flash-message__icon flex_aic_jcc">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" fill="#fff"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M376.6 84.5c11.3-13.6 9.5-33.8-4.1-45.1s-33.8-9.5-45.1 4.1L192 206 56.6 43.5C45.3 29.9 25.1 28.1 11.5 39.4S-3.9 70.9 7.4 84.5L150.3 256 7.4 427.5c-11.3 13.6-9.5 33.8 4.1 45.1s33.8 9.5 45.1-4.1L192 306 327.4 468.5c11.3 13.6 31.5 15.4 45.1 4.1s15.4-31.5 4.1-45.1L233.7 256 376.6 84.5z"/></svg>                                    </div>
                                <p class="flash-message__text">You don't have enough money for this</p>
                            </div>
                        `);                                 
                        $('.flash-message-comment').delay(2000).slideUp(300);
                    }
                    
                },
                error: function(jqXHR, textStatus, errorTh) {
                    console.log(jqXHR, textStatus, errorTh);
                }
            })
        })

        let type_behavior = ['owner', 'favorite', 'voted', 'disvoted']
        for(var behavior of type_behavior) {
            let $conatinerUserBehavior = $(`.${behavior}.container-user-behavior`);
            let $userBehaviorItem = $conatinerUserBehavior.find('.user-behavior__item');
            $userBehaviorItem.each((index, element) => {
                let $followButtonForm = $(element).find(`.follow-button-form`);
                $followButtonForm.on('submit', (e) => {
                    e.preventDefault();
                    $.ajax({
                        type: 'POST',
                        // url: ,
                        data: {
                            'action': 'list_follow',
                            'user_follow_id': $followButtonForm.attr('data-id'),
                            'csrfmiddlewaretoken': $(`input[name=csrfmiddlewaretoken]`).val(),     
                        },
                        success: function(response) {
                            const userFollow = JSON.parse(response.user_follower)[0];
                            const userFollowId = userFollow.pk;
                            const userFollowField = userFollow.fields;
                            
                            let stateOfFollowButton = null;
                            if(response.state == 'follow') {
                                stateOfFollowButton = `
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="list_follow">
                                    <button type="submit" class="follow-button unfollow-button flex_aic_jcc">
                                        <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 448 512" fill="#000"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M432 256c0 17.7-14.3 32-32 32L48 288c-17.7 0-32-14.3-32-32s14.3-32 32-32l352 0c17.7 0 32 14.3 32 32z"/></svg>
                                        Unfollow
                                    </button>
                                `;
                            } 
                            else {
                                stateOfFollowButton = `
                                    {% csrf_token %}
                                    <input type="hidden" name="action" value="list_follow">
                                    <button type="submit" class="follow-button flex_aic_jcc">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 8 8" fill="none">
                                            <path d="M3.2549 0V3.33333H0V4.64762H3.2549V8H4.72549V4.64762H8V3.33333H4.72549V0H3.2549Z" fill="#000"/>
                                        </svg>
                                        Follow
                                    </button>
                                `;
                            }
                            $followButtonForm.html(stateOfFollowButton);
                            let classQuerry = [
                                `.owner.container-user-behavior .user-behavior__item .${userFollowField.name}.follow-button-form`,
                                `.favorite.container-user-behavior .user-behavior__item .${userFollowField.name}.follow-button-form`,
                            ];  

                            $('.voted.container-user-behavior').each((index, element) => {
                                $(element).find(`.${userFollowField.name}.follow-button-form`).html(stateOfFollowButton);
                            })

                            $('.disvoted.container-user-behavior').each((index, element) => {
                                $(element).find(`.${userFollowField.name}.follow-button-form`).html(stateOfFollowButton);
                            })
                            
                            for(let query of classQuerry) {
                                $(query).html(stateOfFollowButton);   
                            }
                        }
                    })
                })
            })
        }

    })
</script>
{% endblock scripts %}